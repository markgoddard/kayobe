---
language: python
python: "2.7"

# Use a VM.
sudo: required

# Install ansible
addons:
  apt:
    packages:
      - gcc
      - python-virtualenv
      - realpath

env:
  # Increase ansible timeout to avoid hitting
  # https://github.com/ansible/ansible/issues/14426.
  - ANSIBLE_TIMEOUT=30

install:
  # Prepare the development configuration.
  - tools/travis-setup.sh
  # Deploy a CentOS controller container.
  - tools/container-deploy.sh
  # Install kayobe control host environment.
  - dev/install.sh

script:
  # Deploy the control plane.
  - dev/overcloud-deploy.sh || (touch failed && false)
  - "[[ -e failed ]] && source dev/environment-setup.sh && kayobe playbook run ansible/ntp.yml"
  - "[[ -e failed ]] && docker exec -it centos-sshd ip a"
  - "[[ -e failed ]] && docker exec -it centos-sshd sudo ip a"
  - "[[ -e failed ]] && ssh root@localhost -p 2223 -o StrictHostKeyChecking=no hostname"
  - "[[ -e failed ]] && ssh stack@localhost -p 2223 -o StrictHostKeyChecking=no hostname"
  - "[[ -e failed ]] && ssh stack@localhost -p 2223 -o StrictHostKeyChecking=no sudo echo hi"
  - "[[ -e failed ]] && docker exec -it centos-sshd sudo journalctl --no-pager"
  - "[[ -e failed ]] && cat ~/ansible.log"
