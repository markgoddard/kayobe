==================================
Working With Multiple Environments
==================================

Sometimes it can be useful to support deployment of multiple environments from
a single Kayobe configuration.  Most commonly this is to support a deployment
pipeline, such as the traditional development, test, staging and production
combination.  As described in :ref:`config-kayobe-inventory-location` and
:ref:`config-kayobe-directory-layout`, it is possible to include multiple
Ansible inventories within a single Kayobe configuration.  This section
outlines some additional considerations that may be required when working with
multiple inventories.

Shared Extra Variables Files
============================

All of the extra variables files in the Kayobe configuration directory
(``$KAYOBE_CONFIG_PATH/*.yml``) are shared between all
environments/inventories.  Moreover, variables specified in these files have
the highest precedence (except for extra variables specified via the ``-e`` CLI
argument).  This means that all configuration in these files must apply to all
environments.  Where configuration differs between environments, it is usually
best to move the configuration to the inventory - typically in a group
variables file.

### FIXME: This doesn't work when variables are defined in playbook group vars.

For example, to add environment-specific DNS configuration for variables in
``dns.yml``, we recommend creating a group variables file for the ``all`` group
in the inventory, at ``$KAYOBE_INVENTORY_PATH/group_vars/all/dns``.

Network Configuration
---------------------

Networking is an area in which configuration is typically specific to an
environment.  There are two main global configuration files that need to be
considered - ``networks.yml`` and ``network-allocation.yml``.

We recommend moving the environment-specific parts of this configuration to
inventory group variables files:

``networks.yml`` -> ``$KAYOBE_INVENTORY_PATH/group_vars/all/networks``
``network-allocation.yml`` -> ``$KAYOBE_INVENTORY_PATH/group_vars/all/network-allocation``

Note that variables defined in these files typically do not have playbook group variables? ## Or do they? _net_name

The IP address allocation file is managed by kayobe, and is typically
autogenerated.  We therefore need to configure kayobe to use this file. For
this we can use ``network-allocation.yml``, ensuring anyone reading the
configuration is redirected to the correct location:

.. code-block:: yaml
   :caption: ``network-allocation.yml``

   ip_allocation_filename: "{{ inventory_path }}/group_vars/all/network-allocation"

Other network configuration that may differ between environments includes DNS
(``dns.yml``), NTP (``ntp.yml``).

Overcloud Host Mapping
----------------------

Typically it is necessary to map overcloud_group_hosts_map
``overcloud.yml``
link to service placement.

Kolla Group Mapping
-------------------

``kolla.yml``.

Other
-----

While it's clearly desirable to keep staging functionally as close to
production, this is not always possible due to resource constraints and other
factors. Test and development environments can deviate further, perhaps only
providing a subset of the functionality available in production, in a
substantially different environment.  In these cases it will clearly be
necessary to use environment-specific configuration in a number of files.  We
can't cover all the cases here, but hopefully we've provided a set of
techniques that can be used.
